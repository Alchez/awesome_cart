{% extends "templates/web.html" %}
{% from "awesome_cart/templates/includes/gateway_macros.html" import embed_gateways, embed_shipping %}
{% from "awesome_cart/templates/includes/gateway_macros.html" import embed_gateways_scripts %}
{% from "awesome_cart/templates/includes/gateway_macros.html" import embed_gateways_styles %}
{% import "awesome_cart/templates/includes/awesome_form_macros.html" as form %}

{% block title %} {{ "Shopping Cart" }} {% endblock %}

{% block header %}{% endblock %}

{% block style %}
<style>
    {% include "templates/includes/dti-forms.css" %}
    {% include "templates/includes/cart.css" %}
    {{ embed_gateways_styles(gateway_forms) }}
</style>
{% endblock %}

{% block header_actions %}{% endblock %}

{% block content %}

{% from "templates/includes/macros.html" import item_name_and_description %}

<div class="row aw-row">
	<div class="col-sm-7 aw-col-left">

		<h2>{{ _("My Cart") }}</h2>
		<div id="cart-full"></div>

	</div>
	<div class="col-sm-5 aw-col-right">
		<div class="col-content focus-column right-col">
			<div class="checkout-breadcrumb">
				<h1>Check Out</h1>
				<div class="page-titles">
				</div>
			</div>
			<div id="awc-checkout-panel">
				<div  id="checkout-login" class="panel">
					<div id="login-form" class="dti-form">
						<h3>Returning Customer</h3>
						{{ form.awinput("text", "customer_email", "Email Address", cls="required") }}
						{{ form.awinput("password", "customer_password", "Password", cls="required submit-on-enter") }}
						{% call form.awactions() %}
							{{ form.awbutton("Login", 1, "btn-login") }}
						{% endcall %}
					</div>
					<div id="register-prompt" class="dti-form">
						<h3>New Customers</h3>
						{% call form.awactions() %}
							{{ form.awbutton("Create Account", 1, "btn-create-account", data={"aw-goto": "#register"}) }}
						{% endcall %}
					</div>
				</div>
				<div  id="register" class="panel">
					<div id="register-form" class="dti-form">
						<h3>Create Account</h3>
						<div class="title">Contact Info</div>
						<div class="row nohpad">
							<div class="col-sm-6 norpad">
								{{ form.awinput("text", "guest_first", "First Name", cls="required") }}
							</div>
							<div class="col-sm-6 nolpad">
								{{ form.awinput("text", "guest_last", "Last Name", cls="required") }}
							</div>
						</div>
						{{ form.awinput("text", "guest_email", "Email Address", cls="required") }}

						<div class="title">Your Password</div>
						{{ form.awpassword("guest_password", "Password", cls="required") }}
						{{ form.awpassword("guest_password_check", "Retype Password", cls="required submit-on-enter", match_val="#guest_password") }}

						{% call form.awactions() %}
							{{ form.awbutton("Back", 0, "btn-back", data={ "aw-goto": "!back" }) }}
							{{ form.awbutton("Register", 1, "btn-register") }}
						{% endcall %}

					</div>
				</div>
				<div  id="checkout-billing" data-next="#checkout-shipping" class="panel">
					{% if gateway_forms|length > 0 %}
					{{ embed_gateways(gateway_forms, has_stored_payments, enable_billing_address, "!next", countries=countries) }}
					{% else %}
					<p>No payment/gateway modules available</p>
					<p>Enable at least one gateway module to continue</p>
					{% endif %}
				</div>
				<div  id="checkout-shipping" data-next="#checkout-confirmation" class="{% if not shipping_enabled %}disabled{% endif %}" class="panel">
					{% if shipping_enabled %}
					{{ embed_shipping("!next", countries=countries) }}
					{% endif %}
				</div>
				<div  id="checkout-confirmation" data-next="#checkout-processing" class="panel">
					<p>Please check review your information before once more before completing checkout</p>
					<div class="confirm-box dti-form" id="checkout-confirm-billing">
						<h4>Billing Information</h4>
						<div class="content"></div>
						{{ form.awbutton("Edit", 1, data={ "aw-goto": "#checkout-billing" }) }}
					</div>

					{% if shipping_enabled %}
					<div class="confirm-box dti-form" id="checkout-confirm-shipping">
						<h4>Shipping Information</h4>
						<div class="content"></div>
						{{ form.awbutton("Edit", 1, data={ "aw-goto": "#checkout-shipping" }) }}
					</div>
					{% endif %}

					<div class="dti-form" id="confirm-form">
						{{ form.awinput("checkbox", "terms", "I agree with the Terms and Conditions", cls="required label-visible", value="1", reverse_label=1 ) }}
						{{ form.awbutton("Confirm and Pay", 1, "btn-confirm") }}
					</div>
				</div>
				<div id="checkout-processing" class="dti-form" class="panel">
					<p>Processing, please wait...</p>
					<div class="feedback">
						<div class="msg"></div>
						{{ form.awbutton("Back", 1, data={ "aw-goto": "#checkout-billing" }) }}
					</div>
					<div class="spinner"></div>
				</div>
				<div id="checkout-success" class="panel">
					<p>Success!</p>
					<p>Now redirecting. Please wait...</p>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- no-sidebar -->
{% endblock %}

{% block script %}
<script>{% include "templates/includes/cart.js" %}</script>
<script type="text/javascript">

// create a full cart feed from awesom cart js
cart.newCartFeed('cart-full', {
  container: '#cart-full',
  tpl: cart.template('cart-full')
})

// initialize gateway form ui
awc.login_form = new awc.Form($('#login-form'));
awc.register_form = new awc.Form($('#register-form'));
awc.confirm_billing_form = new awc.Form($('#checkout-confirm-billing'));
awc.confirm_shipping_form = new awc.Form($('#checkout-confirm-shipping'));
awc.confirm_form = new awc.Form($('#confirm-form'));
awc.gateway.init($('#gateway-form'));
awc.shipping.init($('#shipping-form'));
awc.shipping_enabled = {{ shipping_enabled }};
awc.address_widgets = [];
//awc.shipping_editor = new awc.AddressEditor($('#shipping-form'));

// enable address editors
$('.awc-address.editable').each(function() {
	var $addr_editor = new awc.AddressEditor($(this));
	awc.address_widgets.push($addr_editor);
});

$('#awc-checkout-panel').on('awc-refresh', function() {
	$.each(awc.address_widgets, function(i, editor) {
		editor.update();
	});
});

$(function() {
	$('#awc-checkout-panel').trigger('awc-refresh');
});

awc.checkout_pages = new awc.PagesPanel(
	$('#awc-checkout-panel'),
	{% if is_logged %}'#checkout-billing'{% else %}'#checkout-login'{% endif %}
);

/**
 * Formats confirmation fields
 */
function format_confirm_field(name, meta) {
	if ( meta.type == 'hidden' ) {
		return false;
	}

	var $line = $(
		'<div class="confirm-line field-'+name+'">'+
			'<span class="label">'+meta.label+'</span>: <span class="value">'+meta.human_value+'</span>'+
		'</div>');
	return $line
}

awc.checkout_pages.on_hide('#checkout-confirmation', function() {
	// re-enable shopping cart editing if billing information is displayed
	$('.cart-items .input-group-btn').stop().fadeIn('fast');
	$('.cart-items input').prop('disabled', false);
});

awc.checkout_pages.on_show('#checkout-confirmation #checkout-processing #checkout-success', function() {
	// disable shopping cart editing if billing information is displayed
	$('.cart-items .input-group-btn').stop().fadeOut('fast');
	$('.cart-items input').prop('disabled', true);
});

awc.checkout_pages.on_show('#checkout-confirmation', function() {
	// gather billing and shipping fields to display user a confirmation of their
	// value selections.

	var billing_fields = awc.gateway.get_selected_fields();
	var $bill_content = $('#checkout-confirm-billing .content').empty();
	$.each(billing_fields.meta, function(name, meta) {
		if ( meta.has_value ) {
			var $line = format_confirm_field(name, meta);
			if ( $line ) {
				$bill_content.append($line);
			}
		}
	});

	var $ship_content = $('#checkout-confirm-shipping .content').empty();
	if ( awc.shipping_enabled ) {
		var shipping_fields = awc.shipping.get_selected_fields();
		console.log(shipping_fields);
		$.each(shipping_fields.meta, function(name, meta) {
			if ( meta.has_value ) {
				var $line = format_confirm_field(name, meta);
				if ( $line ) {
					$ship_content.append($line);
				}
			}
		});
	}
});

awc.confirm_form.$form.on('submit_action', function(e, fields, done, error) {
	var billing_gateway = awc.gateway.get_selected_form();
	var billing_fields = awc.gateway.get_selected_fields();
	var confirm_fields = awc.confirm_form.get_fields();
	var form = {
		billing: {
			gateway: billing_gateway.value,
			fields: billing_fields.fields
		},
		shipping: null,
		confim: {
			fields: confirm_fields.fields
		}
	}

	if ( awc.shipping_enabled ) {
		var shipping_fields = awc.shipping.get_selected_fields();
		form.shipping = {
			fields: shipping_fields.fields
		};
	}

	awc.checkout_pages.show('#checkout-processing');
	$('#checkout-processing .msg').empty();
	$('#checkout-processing .feedback').hide();
	$('#checkout-processing .spinner').show();

	frappe.call({
		method: "awesome_cart.cart.checkout",
		args: { form: form },
		callback: function(r) {
			var result = r.message;
			if ( result.success ) {
				awc.checkout_pages.show('#checkout-success');
				window.location = '/cart_success/' + result.so_name;
			} else {
				//error(result.msg); Don't show error back in confirm form

				$("#checkout-processing .msg").html("<div>"+result.msg + "</div>" + ('exception' in result?"<pre>" + result.exception + "</pre>":""));
				$("#checkout-processing .feedback").slideDown('fast');
				$('#checkout-processing .spinner').slideUp('fast');

			}
		}
	});

	done(); // spinner will appear on processing page

});

awc.login_form.$form.on('submit_action', function(e, fields, done, error) {
	var email = fields.fields.customer_email;
	var pass = fields.fields.customer_password;

	frappe.call({
		method: "awesome_cart.cart.login",
		args: {
			"email": email,
			"password": pass,
		},
		callback: function(r) {
			var result = r.message;
			if ( result.success ) {
				awc.checkout_pages.show('#checkout-billing');
				$('#awc-checkout-panel').trigger('awc-refresh');
				$('.full-name').text(result.user.full_name);
				frappe.full_name = result.user.full_name;
				frappe.user_id = result.user.name;
			} else {
				error(result.msg);
			}
			done();
		}
	});

});

awc.register_form.$form.on('submit_action', function(e, fields, done, error) {

	var $form = $('#register-form');
	var email = $('#guest_email').val();
	var pass = $('#guest_password').val();
	var pass_check = $('#guest_password_check').val();
	var first = $("#guest_first").val();
	var last = $("#guest_last").val();

	frappe.call({
		method: "awesome_cart.cart.register",
		args: {
			"email": email,
			"password": pass,
			"password_check": pass_check,
			"first_name": first,
			"last_name": last
		},
		callback: function(r) {
			result = r.message;
			if ( result.success ) {
				awc.checkout_pages.show('#checkout-billing');
				$('.full-name').text(result.user.full_name);
				frappe.full_name = result.user.full_name;
				frappe.user_id = result.user.name;
			} else {
				error(result.msg);
			}

			done();
		}
	});

});

awc.checkout_pages.start();

</script>

{{ embed_gateways_scripts(gateway_forms) }}

{% endblock %}

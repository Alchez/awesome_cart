{% extends "templates/web.html" %}
{% from "awesome_cart/templates/includes/gateway_macros.html" import embed_gateways %}
{% from "awesome_cart/templates/includes/gateway_macros.html" import embed_gateways_scripts %}
{% from "awesome_cart/templates/includes/gateway_macros.html" import embed_gateways_styles %}
{% import "awesome_cart/templates/includes/awesome_form_macros.html" as form %}

{% block title %} {{ "Shopping Cart" }} {% endblock %}

{% block header %}{% endblock %}

{% block style %}
<style>
    {% include "templates/includes/dti-forms.css" %}
    {% include "templates/includes/cart.css" %}
    {{ embed_gateways_styles(gateway_forms) }}
</style>
{% endblock %}

{% block header_actions %}{% endblock %}

{% block content %}

{% from "templates/includes/macros.html" import item_name_and_description %}

<div class="row aw-row">
	<div class="col-sm-7 aw-col-left">
		<h2>{{ _("My Cart") }}</h2>
		<div class="cart-content">
			<div id="cart-container">
				<div id="cart-error" class="alert alert-danger"
			    style="display: none;"></div>
			<div id="cart-items">
			    <div class="row cart-item-header">
				<div class="col-sm-8 col-xs-6">
				    Items
				</div>
				<div class="col-sm-2 col-xs-3 text-right">
				    Qty
				</div>
				<div class="col-sm-2 col-xs-3 text-right">
				    Amount
				</div>
			    </div>
			    {% if doc.items %}
			    <div class="cart-items">
			    {% include "templates/includes/cart/cart_items.html" %}
			    </div>
			    {% else %}
			    <p>{{ _("Cart is Empty") }}</p>
			    {% endif %}
			</div>
			{% if doc.items %}
			<!-- taxes -->
			<div class="cart-taxes row small">
			    <div class="col-sm-8"><!-- empty --></div>
			    <div class="col-sm-4 cart-tax-items">
				{% include "templates/includes/order/order_taxes.html" %}
			    </div>
			</div>
			<div id="cart-totals">
			</div>
<!--
			<div class="cart-addresses">
			    {% include "templates/includes/cart/cart_address.html" %}
			</div>
			<p class="cart-footer text-right">
			    <button class="btn btn-primary btn-place-order btn-sm" type="button">
				{{ _("Place Order") }}</button></p>
 -->
			{% endif %}

		    </div>
		</div>

	</div>
	<div class="col-sm-5 aw-col-right">
		<div class="col-content focus-column right-col">
			<div class="checkout-breadcrumb">
				<h1>Check Out</h1>
				<div class="page-titles">
				</div>
			</div>
			<div class="checkout-page" id="checkout-login">
				<div id="login-form" class="dti-form">
					<h3>Returning Customer</h3>
					{{ form.awinput("text", "customer_email", "Email Address", cls="required") }}
					{{ form.awinput("password", "customer_password", "Password", cls="required submit-on-enter") }}
					{% call form.awactions() %}
						{{ form.awbutton("Login", 1, "btn-login") }}
					{% endcall %}
				</div>
				<div id="register-prompt" class="dti-form">
					<h3>New Customers</h3>
					{% call form.awactions() %}
						{{ form.awbutton("Create Account", 1, "btn-create-account", data={"aw-goto": "#register"}) }}
					{% endcall %}
				</div>
			</div>
			<div class="checkout-page" id="register">
				<div id="register-form" class="dti-form">
					<h3>Create Account</h3>
					<div class="title">Contact Info</div>
					<div class="row nohpad">
						<div class="col-sm-6 norpad">
							{{ form.awinput("text", "guest_first", "First Name", cls="required") }}
						</div>
						<div class="col-sm-6 nolpad">
							{{ form.awinput("text", "guest_last", "Last Name", cls="required") }}
						</div>
					</div>
					{{ form.awinput("text", "guest_email", "Email Address", cls="required") }}

					<div class="title">Your Password</div>
					{{ form.awpassword("guest_password", "Password", cls="required") }}
					{{ form.awpassword("guest_password_check", "Retype Password", cls="required submit-on-enter", match_val="#guest_password") }}

					{% call form.awactions() %}
						{{ form.awbutton("Register", 1, "btn-register") }}
					{% endcall %}

				</div>

			</div>
			<div class="checkout-page" id="checkout-billing">
				{{ embed_gateways(gateway_forms, stored_payments, enable_billing_address, "checkout-shipping", countries=countries) }}
			</div>
			<div class="checkout-page" id="checkout-shipping">
			</div>
			<div class="checkout-page" id="checkout-confirmation">
			</div>
		</div>
	</div>
</div>

<!-- no-sidebar -->
{% endblock %}

{% block script %}
<script>{% include "templates/includes/cart.js" %}</script>
<script>{% include "templates/includes/awesome_cart.js" %}</script>
<script type="text/javascript">

// initialize gateway form ui
var login_form = new awc.Form($('#login-form'));
var register_form = new awc.Form($('#register-form'));
awc.gateway.init($('#gateway-form'));

awc.ui.action_error = function($btn, reset) {
	if ( reset ) {
		$btn.parent().find('.action-error').slideUp('fast').empty();
	} else {
		$btn.parent().find('.action-error').slideDown('fast');
	}
}

awc.ui.action_wait = function($btn, reset) {
	if ( reset ) {
		$btn.slideDown('fast');
		$btn.parent().find('.action-spinner').slideUp('fast');
	} else {
		awc.ui.action_error($btn, true); // reset error msg
		$btn.slideUp('fast');
		$btn.parent().find('.action-spinner').slideDown('fast');
	}
}

{% if is_logged %}
awc.ui.goto('#checkout-billing');
{% else %}
awc.ui.goto('#checkout-login');
{% endif %}

$('#login-form .btn-login').click(function() {
	if ( $(this).closest('.dti-form').hasClass('incomplete') ) {
		return;
	}	

	var $btn = $(this);
	var email = $('#customer_email').val();
	var pass = $('#customer_password').val();

	awc.ui.action_wait($btn); // show spinner
	frappe.call({
		method: "awesome_cart.cart.login",
		args: {
			"email": email, 
			"password": pass,
		},
		callback: function(r) {
			var result = r.message;
			if ( result.success ) {
				awc.ui.goto('#checkout-billing');
			} else {
				awc.ui.action_error($btn, result.msg);
			}
			awc.ui.action_wait($btn, true);
		}
	});

});

$('#register-form .btn-register').click(function() {

	console.log("About to register");
	var $btn = $(this);
	var $form = $('#register-form');
	var email = $('#guest_email').val();
	var pass = $('#guest_password').val();
	var pass_check = $('#guest_password_check').val();
	var first = $("#guest_first").val();
	var last = $("#guest_last").val();

	var form = $form.data('awc_form');

	//awc.ui.action_wait($btn); // show spinner
	form.on_action_wait();

	frappe.call({
		method: "awesome_cart.cart.register",
		args: {
			"email": email, 
			"password": pass, 
			"password_check": pass_check,
			"first_name": first,
			"last_name": last
		},
		callback: function(r) {
			result = r.message;
			if ( result.success ) {
				awc.ui.goto('#checkout-billing');
			} else {
				form.on_action_error(result.msg);
				//awc.ui.action_error($btn, result.msg);
			}

			form.on_action_wait(true);
			//awc.ui.action_wait($btn, true); // reset spinner
		}
	});

});

</script>

{{ embed_gateways_scripts(gateway_forms) }}

{% endblock %}
